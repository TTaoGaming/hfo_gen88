# HFO Gen 88 - Silver Tier Nightly Regression
# SOTA Pareto-Optimal CI/CD with Tamper-Evident Receipts
#
# Schedule: Every night at 2 AM UTC
# Purpose: Deep verification of Silver tier with mutation testing

name: Silver Nightly Regression

on:
  schedule:
    # Run at 2 AM UTC every day
    - cron: '0 2 * * *'
  workflow_dispatch:
    # Allow manual trigger
    inputs:
      skip_mutation:
        description: 'Skip mutation testing (faster)'
        required: false
        default: false
        type: boolean

env:
  NODE_VERSION: '20'
  HIVE: 'HFO_GEN88'
  GEN: '88'

jobs:
  silver-regression:
    name: Silver Tier Regression
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
      
      - name: Install Dependencies
        run: npm ci
      
      - name: Run Silver Health Check
        id: health
        run: |
          echo "üß™ Running Silver tier tests..."
          npm run silver:health
          echo "health_status=pass" >> $GITHUB_OUTPUT
        continue-on-error: true
      
      - name: Run Nightly Regression
        if: inputs.skip_mutation != 'true'
        id: nightly
        run: |
          echo "üåô Running full nightly regression..."
          npm run silver:nightly
          echo "nightly_status=pass" >> $GITHUB_OUTPUT
        continue-on-error: true
      
      - name: Upload Mutation Reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: mutation-reports-${{ github.run_number }}
          path: |
            hot_obsidian_sandbox/bronze/3_resources/reports/*.json
            reports/*.json
          retention-days: 30
      
      - name: Upload Blackboard
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: blackboard-${{ github.run_number }}
          path: hot_obsidian_sandbox/hot_obsidianblackboard.jsonl
          retention-days: 90
      
      - name: Check Results
        run: |
          if [ "${{ steps.health.outcome }}" == "failure" ]; then
            echo "‚ùå Silver health check failed!"
            exit 1
          fi
          if [ "${{ steps.nightly.outcome }}" == "failure" ]; then
            echo "‚ö†Ô∏è Nightly regression detected issues"
            exit 1
          fi
          echo "‚úÖ All checks passed!"

  notify-on-failure:
    name: Notify on Failure
    needs: silver-regression
    if: failure()
    runs-on: ubuntu-latest
    
    steps:
      - name: Create Issue on Failure
        uses: actions/github-script@v7
        with:
          script: |
            const date = new Date().toISOString().split('T')[0];
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `üö® Silver Nightly Regression Failed - ${date}`,
              body: `## Nightly Regression Failure
              
              **Date:** ${date}
              **Run:** [#${{ github.run_number }}](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
              
              ### Action Required
              - Review the failed tests
              - Check mutation scores for degradation
              - Fix regressions before next commit
              
              ### Artifacts
              - Mutation reports attached to workflow run
              - Blackboard receipts available for audit
              
              ---
              *Generated by HFO Gen 88 Immune System (Port 4)*`,
              labels: ['regression', 'silver-tier', 'automated']
            });
